<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_cron().
 */
function filelink_usage_cron() {
  $config = \Drupal::configFactory()->getEditable('filelink_usage.settings');
  $frequency = $config->get('scan_frequency');
  $last_scan = (int) $config->get('last_scan');
  $intervals = [
    'hourly' => 3600,
    'daily' => 86400,
    'weekly' => 604800,
  ];
  $interval = $intervals[$frequency] ?? 86400;
  $now = \Drupal::time()->getRequestTime();

  if ($interval && $last_scan + $interval > $now) {
    return;
  }

  $database = \Drupal::database();
  $threshold = $now - 86400;
  $query = $database->select('node_field_data', 'n');
  $query->leftJoin('filelink_usage_scan_status', 's', 'n.nid = s.nid');
  $query->fields('n', ['nid']);
  $or = $query->orConditionGroup()
    ->isNull('s.scanned')
    ->condition('s.scanned', $threshold, '<');
  $nids = $query->condition($or)->execute()->fetchCol();

  if ($nids) {
    \Drupal::service('filelink_usage.scanner')->scan($nids);
  }

  $config->set('last_scan', $now)->save();
}

/**
 * Scan a single node for file links and update usage.
 */
function filelink_usage_rescan_node(NodeInterface $node) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $file_usage = \Drupal::service('file.usage');
  $database = \Drupal::database();

  // Remove any existing matches and file usage entries for this node so we
  // can record a fresh set of links.
  $links = $database->select('filelink_usage_matches', 'f')
    ->fields('f', ['link'])
    ->condition('nid', $node->id())
    ->execute()
    ->fetchCol();

  foreach ($links as $link) {
    $uri = $link;
    if (preg_match('#https?://[^/]+(/sites/default/files/.*)#i', $uri, $m)) {
      $uri = $m[1];
    }
    if (strpos($uri, '/sites/default/files/') === 0) {
      $uri = 'public://' . substr($uri, strlen('/sites/default/files/'));
    }

    $file_storage = $entity_type_manager->getStorage('file');
    $files = $file_storage->loadByProperties(['uri' => $uri]);
    $file = $files ? reset($files) : NULL;
    if ($file) {
      $file_usage->delete($file, 'filelink_usage', 'node', $node->id());
    }
  }

  $database->delete('filelink_usage_matches')
    ->condition('nid', $node->id())
    ->execute();

  foreach ($node->getFields() as $field) {
    $type = $field->getFieldDefinition()->getType();
    if ($type === 'text_long' || $type === 'text_with_summary') {
      $text = $field->value;
      preg_match_all('/(public:\/\/[^\s"\']+|\/sites\/default\/files\/[^\s"\']+|https?:\/\/[^\/"]+\/sites\/default\/files\/[^\s"\']+)/i', $text, $matches);
      foreach ($matches[0] as $match) {
        $uri = $match;
        if (preg_match('#https?://[^/]+(/sites/default/files/.*)#i', $uri, $m)) {
          $uri = $m[1];
        }
        if (strpos($uri, '/sites/default/files/') === 0) {
          $uri = 'public://' . substr($uri, strlen('/sites/default/files/'));
        }

        $file_storage = $entity_type_manager->getStorage('file');
        $files = $file_storage->loadByProperties(['uri' => $uri]);
        $file = $files ? reset($files) : NULL;

        if ($file) {
          $usage = $file_usage->listUsage($file);
          if (empty($usage['filelink_usage']['node'][$node->id()])) {
            $file_usage->add($file, 'filelink_usage', 'node', $node->id());
          }
        }

        $database->merge('filelink_usage_matches')
          ->key([
            'nid' => $node->id(),
            'link' => $match,
          ])
          ->fields([
            'timestamp' => time(),
          ])
          ->execute();
      }
    }
  }
}

/**
 * Mark a node as needing a rescan.
 */
function filelink_usage_mark_for_rescan(NodeInterface $node) {
  \Drupal::database()->delete('filelink_usage_scan_status')
    ->condition('nid', $node->id())
    ->execute();
}

/**
 * Implements hook_entity_insert().
 */
function filelink_usage_entity_insert(EntityInterface $entity) {
  if ($entity instanceof NodeInterface) {
    filelink_usage_mark_for_rescan($entity);
  }
}

/**
 * Implements hook_entity_update().
 */
function filelink_usage_entity_update(EntityInterface $entity) {
  if ($entity instanceof NodeInterface) {
    filelink_usage_mark_for_rescan($entity);
  }
}

/**
 * Implements hook_entity_delete().
 */
function filelink_usage_entity_delete(EntityInterface $entity) {
  if ($entity instanceof NodeInterface) {
    $database = \Drupal::database();
    $file_usage = \Drupal::service('file.usage');
    $entity_type_manager = \Drupal::entityTypeManager();

    $links = $database->select('filelink_usage_matches', 'f')
      ->fields('f', ['link'])
      ->condition('nid', $entity->id())
      ->execute()
      ->fetchCol();

    foreach ($links as $link) {
      $uri = $link;
      if (preg_match('#https?://[^/]+(/sites/default/files/.*)#i', $uri, $m)) {
        $uri = $m[1];
      }
      if (strpos($uri, '/sites/default/files/') === 0) {
        $uri = 'public://' . substr($uri, strlen('/sites/default/files/'));
      }
      $file_storage = $entity_type_manager->getStorage('file');
      $files = $file_storage->loadByProperties(['uri' => $uri]);
      $file = $files ? reset($files) : NULL;
      if ($file) {
        $file_usage->delete($file, 'filelink_usage', 'node', $entity->id());
      }
    }

    $database->delete('filelink_usage_matches')
      ->condition('nid', $entity->id())
      ->execute();

    $database->delete('filelink_usage_scan_status')
      ->condition('nid', $entity->id())
      ->execute();
  }
}
